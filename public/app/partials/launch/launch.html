<br />
<div class="tabpanel">
    <ul class="nav nav-tabs" role="tablist">
        <li>
            <a ng-href="#/testplan/{{ launch.test_plan }}" style="cursor: pointer;"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span> Back to testplan</a>
        </li>
        <li role="presentation"  ng-class="{ 'active': finished }">
            <a ng-click="finished = true; closeTask()" aria-controls="counters" role="tab" data-toggle="tab" style="cursor: pointer;">Counters</a>
        </li>
        <li role="presentation" ng-class="{ 'active': !finished }">
            <a ng-click="finished = false" aria-controls="tasks" role="tab" data-toggle="tab" style="cursor: pointer;">
                <div ng-if="launch.state === 0">
                    <span class="glyphicon glyphicon-exclamation-sign"></span>
                    Tasks in progress...
                </div>
                <div ng-if="launch.state === 2 || launch.state === 3">Tasks</div>
            </a>
        </li>
        <li role="presentation" class="pull-right">
            <a><span class="glyphicon glyphicon-question-sign" ng-click="open('launch/results')"></span></a>
        </li>
    </ul>

    <div class="tab-content">
        <div role="tabpanel" class="tab-pane" id="counters" ng-class="{ 'active': finished }">
            <div class="row">
                <div class="col-md-6">
                <table class="table table-striped table-condensed">
                    <thead>
                        <tr><th>Param</th><th>Value</th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Test plan id</td>
                            <td>{{ launch.test_plan }}</td>
                        </tr>
                        <tr>
                            <td>Launch date</td>
                            <td>{{ launch.created | date: "d/M/y H:mm" }}</td>
                        </tr>
                        <tr>
                            <td>Finish date</td>
                            <td>{{ launch.finished | date: "d/M/y H:mm" }}</td>
                        </tr>
                        <tr>
                            <td>Duration</td>
                            <td>{{ launch.duration }} min.</td>
                        </tr>
                        <tr>
                            <td>ENV</td>
                            <td>
                                <ul><li ng-repeat="(key, value) in launch.parameters.env">{{ key }}: {{ value }}</li></ul>
                            </td>
                        </tr>
                        <tr ng-repeat="(key, value) in launch.parameters.options">
                            <td>{{ key }}</td>
                            <td>
                                <span ng-if="key!=='started_by'">{{ value }}</span>
                                <!-- Not ng-href, because we open link in new tab -->
                                <a ng-if="key==='started_by'" href="{{ launch.started_by }}" target="_blank">{{ launch.started_by }}</a>
                            </td>
                        </tr>
                    </tbody>
                </table>
                </div>
                <div class="col-md-6">
                    <table ng-table="comments" class="table table-condensed table-striped">
                        <tr ng-repeat="comment in $data">
                            <td class="col-md-3" data-title="'User & date'">{{ comment.user_data.username }}<br />{{ comment.submit_date | date: "d/M/y H:mm" }}</td>
                            <td class="col-md-9" data-title="'Comment'"><pre>{{ comment.comment }}</pre></td>
                        </tr>
                    </table>
                    <button class="btn btn-default" ng-click="openAddCommentModal()">Add comment</button>
                </div>
            </div>

            <div class="well">
                <div ng-class="{ 'disabled': !apiErrors, 'alert alert-danger': apiErrors}" role="alert">{{ apiErrors }}</div>
                <form class="form-inline" ng-submit="addBug()">
                    <a ng-click="state = 0" class="btn btn-sm btn-success" ng-class="{ 'active': state == 0 }">Passed {{ launch.counts.passed }}</a>
                    <a ng-click="state = 1" class="btn btn-sm btn-danger" ng-class="{ 'active': state == 1 }">Failed {{ launch.counts.failed }}</a>
                    <a ng-click="state = 2" class="btn btn-sm btn-warning" ng-class="{ 'active': state == 2 }"> Skipped {{ launch.counts.skipped }}</a>
                    <a ng-click="state = 3" class="btn btn-sm btn-danger" ng-class="{ 'active': state == 3 }"> Blocked {{ launch.counts.blocked }}</a>

                    <div class="form-group" ng-show="jira">
                        <span class="glyphicon glyphicon-minus"></span>
                        <div class="input-group">
                            <input type="text" class="form-control input-sm" placeholder="Issue Id" ng-model="bugId">
                        </div>
                        <div class="input-group">
                            <input type="text" class="form-control input-sm" placeholder="Regex" ng-model="regExp">
                        </div>
                        <input type="submit" class="btn btn-sm btn-primary" ng-disabled="!bugId || !regExp || bugId === '' || regExp === ''" value="Add">
                    </div>
                    <span class="glyphicon glyphicon-minus"></span>
                    <button go-click="/testplan/{{ launch.test_plan }}/execute/{{ launch.id }}" class="btn btn-sm btn-primary" ng-disabled="profile === null">Relaunch</button>
                    <a ng-show="(launch.state === 0 || launch.state === 1) && profile !== null" class="btn btn-sm btn-primary pull-right"
                            ng-click="terminateLaunchTasks(launch.id)" ng-disabled="terminateButtonActive === false">
                        <span class="glyphicon glyphicon-exclamation-sign"></span>
                        Terminate launch
                    </a>
                </form>
            </div>
            <table ng-table="tableParams" show-filter="true" class="table table-condensed table-bordered table-hover table-striped">
                <tbody ng-repeat="(key, group) in $data">
                <tr class="ng-table-group">
                    <td colspan="{{ $columns.length }}">
                        <a href="" ng-click="group.$hideRows = !group.$hideRows">
                            <span class="glyphicon" ng-class="{ 'glyphicon-chevron-right': group.$hideRows, 'glyphicon-chevron-down': !group.$hideRows }"></span>
                            <strong>{{ getLaunchItemById(key).name }} ({{ group.length }})</strong>
                        </a>
                    </td>
                </tr>
                <tr ng-hide="group.$hideRows" ng-repeat="test in group" ng-click="openResults(test, $index)" style="cursor:pointer" ng-class="{'hidden': test.hidden }">
                    <td data-title="'Failure reason'" filter="{'failure_reason': 'text'}">
                        <pre ng-if="test.failure_reason==='' && test.suite">{{ test.suite }}:{{ test.name }}</pre>
                        <pre ng-if="test.failure_reason==='' && !test.suite">{{ test.name }}</pre>
                        <pre ng-if="test.failure_reason!==''">{{ test.failure_reason | cut:true:256:' ...' }}</pre>
                    </td>
                    <td data-title="'sec.'" sortable="duration">{{ test.duration | toFixed }}</td>
                    <td data-title="'Bugs'">
                        <div ng-repeat="bug in test.bugs">
                            <a class="label label-{{ bug.status | bugStatusClass }}"
                               href="https://jira.2gis.ru/browse/{{ bug.externalId }}"
                               title="{{ bug.name }}">{{ bug.externalId }}</a>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div role="tabpanel" class="tab-pane" id="tasks" ng-class="{ 'active': !finished }">
            <br />
            <div class="row" ng-if="currentTask === null">
                <table class="table table-condensed table-hover table-striped">
                    <thead>
                        <tr><th>Name</th><th>Stdout</th><th>Status</th><th>Duration</th></tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="task in tasks" ng-class="{ 'info': task.type === 1, 'warning': task.type === 2 }">
                            <td>{{ task.item.name }}</td>
                            <td ng-class="{'danger': task.result.result.return_code != 0 && task.result.status !== 'PENDING' }"
                                ng-click="openTask(task)"
                                style="cursor: pointer;">
                                {{ task.result.result.stdout|cut:true:256:' ...' }}
                                <div ng-if="task.result.result.stderr && task.result.result.stderr!=='Soft timeout limit exceeded. SoftTimeLimitExceeded()'">
                                    <span class="label label-warning"><span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>&nbsp;stderr not empty</span>
                                </div>
                                <div ng-if="task.result.result.stderr && task.result.result.stderr==='Soft timeout limit exceeded. SoftTimeLimitExceeded()'">
                                    <span class="label label-info"><span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>&nbsp;timeout limit exceeded</span>
                                </div>

                            </td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar active {{ task.result.status | progressBarClass }}"
                                         role="progressbar"
                                         aria-valuenow="100"
                                         aria-valuemin="0"
                                         aria-valuemax="100"
                                         style="width: 100%;">
                                        <span style="margin:5px">{{ task.result.status }}</span>
                                    </div>
                                </div>
                            </td>
                            <td><span ng-if="task.result.result.delta">{{ task.result.result.delta | toFixed }}</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="row" ng-if="currentTask !== null">
            <a ng-click="closeTask()" class="btn btn-primary"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span> Back</a>
            <h3 ng-bind="currentTask.item.name"></h3>
            <div ng-if="currentTask.result.result.start">
                <h4>Time</h4>
                <table class="table table-condensed table-striped">
                    <tr><td>Start</td><td ng-bind="currentTask.result.result.start"></td></tr>
                    <tr><td>End</td><td ng-bind="currentTask.result.result.end"></td></tr>
                    <tr><td>Duration</td><td ng-bind="currentTask.result.result.delta"></td></tr>
                </table>
            </div>
            <div ng-if="currentTask.result.result.stdout">
                <h4>Stdout</h4>
                <pre ng-bind="currentTask.result.result.stdout"></pre>
            </div>
            <div ng-if="currentTask.result.result.stderr">
                <h4>Stderr</h4>
                <pre ng-bind="currentTask.result.result.stderr"></pre>
            </div>
            <div ng-if="currentTask.result.result.env">
                <h4>Env</h4>
                <pre>{{ currentTask.result.result.env | jsonToString }}</pre>
            </div>
            <a ng-click="closeTask()" class="btn btn-primary"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span> Back</a>
        </div>
    </div>

    <div class="modal" id="TestDetailsModal" tabindex="-1" role="dialog"
         aria-labelledby="TestDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Next</span>
                    </button>
                    <div class="btn-group">
                        <button type="button" class="btn btn-xs btn-primary" ng-click="prevItem()">
                            <span class="glyphicon glyphicon-chevron-left"></span>
                        </button>
                        <button type="button" class="btn btn-xs btn-primary" ng-click="nextItem()">
                            <span class="glyphicon glyphicon-chevron-right"></span>
                        </button>
                    </div>
                    use keyboard <span class="label label-info">j</span> and
                    <span class="label label-info">k</span> or
                    <span class="label label-info">arrow right</span> and
                    <span class="label label-info">arrow left</span> for navigation
                    <h4 class="modal-title" id="TestDetailsModalLabel">
                        {{ modalSuite }} <strong>{{ modalName }}</strong>
                    </h4>
                </div>

                <div class="modal-body">
                    <pre ng-if="modalBody===''">Test is passed. Failure reason is empty.</pre>
                    <pre ng-if="modalBody!==''" ng-bind-html="modalBody | linky:'_blank'"></pre>
                    <a class="btn" ng-href="#testresult/{{ modalId }}/" ng-if="!modalHideTestControls">Open detailed view <i class="glyphicon glyphicon-share"></i></a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="AddCommentModal" tabindex="-1" role="dialog" aria-labelledby="AddCommentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Next</span>
                    </button>
                    <h4 class="modal-title" id="AddCommentModalLabel">Add comment</h4>
                </div>

                <div class="modal-body">
                    <div ng-class="{ 'disabled': !formErrors, 'alert alert-danger': formErrors}" role="alert">{{ formErrors }}</div>
                    <textarea ng-model="form_comment" class="form-control" rows="5"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" ng-click="submitComment()" ng-disabled="comment_disabled || formError || form_comment === ''">Submit</button>
                </div>
            </div>
        </div>
    </div>
</div>